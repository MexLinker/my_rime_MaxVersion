# Dev Troubleshooting

This doc explains common issues when running the local demo via `script_Max/run_local.sh` or `run_local.ps1`, and how we fixed them.

## 1) RollupError: Could not resolve "../schema-name.json" from "src/worker.ts"
- Cause: The local worker build (`pnpm run worker`) reads several JSON indices generated by the schema installer: `schema-name.json`, `schema-files.json`, `schema-target.json`, `dependency-map.json`, `target-files.json`, `target-version.json`.
- Those files are created by `pnpm run schema`, which itself requires a native build (`pnpm run native`) to produce `build/librime_native/bin/...`.
- Our one-click demo path intentionally avoids heavy native/WASM builds by downloading the prebuilt `public/worker.js` from CDN. If the dev process auto-builds the worker, it fails when the JSON files are missing.
- Fix applied: The dev config no longer auto-triggers `pnpm run worker` on `worker.ts` load. It only watches the JSON files. With the prebuilt worker present, dev runs cleanly.
- If you actually want to build locally, run:
  - `pnpm run native && pnpm run schema && pnpm run wasm && pnpm run worker`

## 2) Port not matching `--port` passed to run script
- Symptom: Running `./run_local.sh --port 5043` still shows Vite using `5173`.
- Cause: Passing `--` split arguments resulted in `vite --host -- --port 5043`, where the extra `--` stopped option parsing and Vite ignored `--port`.
- Fix applied: The run scripts set `PORT` (and `VITE_PORT`) environment variables, and Vite reads them via `vite.config.ts` to set `server.port`. Now the dev server respects the chosen port.

## 3) API health check initially shows connection refused
- Symptom: A few `curl: (7) Failed to connect to localhost:8787` lines appear, followed by `API server is healthy.`
- Cause: The API server starts in the background; the health check loop probes `/api/health` while the server is booting. A handful of failed probes are normal until the server binds.
- Behavior: Once the health check succeeds, the dev server proceeds. You can view API logs in `.api.log` if needed.

## 4) CDN blocked / slow in mainland China
- Symptom: `curl` stalls when downloading `public/worker.js` from `jsdelivr`.
- Fix applied: `--china` / `-China` switches prefer `npmmirror.com` and retry with fallbacks (`jsdelivr`, `unpkg`) using short timeouts.
- Tip: Combine with `--proxy HOST:PORT` or `-Proxy "HOST:PORT"` in restrictive networks.

## 5) If you want a fully offline local build
- Install build tools (`cmake`, `ninja`, compilers, emscripten), then:
  - `pnpm run native`
  - `pnpm run schema`
  - `pnpm run lib`
  - `pnpm run wasm`
  - `pnpm run worker`
- Finally run `pnpm run dev`.