# Troubleshooting (Based on error.md)

This note addresses the issues captured in `script_Max/error.md` and provides fixes.

## RollupError: Could not resolve "../schema-name.json" from "src/worker.ts"
- What happened: The dev run triggered `pnpm run worker` (Rollup worker build). That build imports several JSON indices:
  - `schema-name.json`, `schema-files.json`, `schema-target.json`, `dependency-map.json`, `target-files.json`, `target-version.json`.
- Why it failed: These files are only generated by `pnpm run schema`, which relies on a native build (`pnpm run native`). Our demo path uses a prebuilt `public/worker.js` and does not generate those JSON files by default.
- Fix we applied:
  - We disabled automatic worker builds unless explicitly requested by setting `RUN_WORKER`.
  - In `vite.config.ts`, worker auto-build runs only when `RUN_WORKER=1` is present in the environment.
- How to opt-in to local worker builds:
  - Run: `pnpm run native && pnpm run schema && pnpm run wasm && pnpm run worker`.
  - Then start dev with `RUN_WORKER=1 PORT=5042 pnpm run dev` if you want auto rebuild when schema JSON change.

## API Health Check: "Connection refused" messages, then healthy
- What you saw: A few `curl: (7) Failed to connect to localhost:8787`, followed by `API server is healthy.`
- Why: The API server starts in the background; the health loop probes `/api/health` while it’s booting. A small number of failed probes is expected before the port binds.
- Tip: Inspect `.api.log` for server output if health checks keep failing.

## Dev Port Mismatch (now fixed)
- Symptom previously: Passing `--port` did not affect Vite, which still showed 5173.
- Fix: The run scripts export `PORT`/`VITE_PORT` and `vite.config.ts` reads them (`server.port`). Dev now binds to your requested port.
- Example: `./script_Max/run_local.sh --port 5042` → Vite shows `Local: http://localhost:5042/`.

## CDN download reliability (China-friendly)
- If `jsdelivr` is slow or blocked, the script now tries multiple sources with short timeouts:
  - `npmmirror.com` → `jsdelivr` → `unpkg` (when using `--china`/`-China`).
- Use a proxy when needed: `--proxy 127.0.0.1:7890` or PowerShell `-Proxy "127.0.0.1:7890"`.

## Quick Reference
- Demo run (no local builds): `./script_Max/run_local.sh --port 5042`.
- China-friendly run: `./script_Max/run_local.sh --china --port 5042`.
- Full local builds:
  - `pnpm run native && pnpm run schema && pnpm run wasm && pnpm run worker`.
  - Start dev with `RUN_WORKER=1` if you want worker auto-builds on JSON changes.